<% day = calendar.startdt %>
<table class="cal" width="100%">
<thead>
  <tr>
    <th scope="col" title="<%= l(:label_week) %>" class="week-number">KW</th>
    <% 7.times do |i| %>
      <th scope="col" width="14%" align="center"><%= day_name( (calendar.first_wday+i)%7 ) %></th>
    <% end %>
  </tr>
</thead>
<tbody>
  <tr>
<% day = calendar.startdt
  while day <= calendar.enddt
    weekend = (day.wday%7 == 6 || day.wday%7 == 0)
    if day.cwday == calendar.first_wday %>
      <td valign="top" class="week-number" title="<%= l(:label_week) %>">
        <p><%= (day+(11-day.cwday)%7).cweek %></p>
      </td>
<%  end %>
    <td class="<%= 'today' if Date.today == day %><%= ' event' if !calendar.events_on(day).empty? %>
    <% unless @listOfDaysBetween.nil? %><%= ' weekend' if weekend %>
    <%= ' e_'+@listOfDaysBetween[day.to_date.to_s][:id].to_s if @listOfDaysBetween[day.to_date.to_s] %>" valign="top" id="day_<%= day.day%>"<%end%>>
      <div class="td_box noSelect">
        <p class="day-num" title="<%=format_date(day)%>"><%= day.day %></p>
        <%= calendar.events_on(day) %>
        <% calendar.events_on(day).each do |i| %>
          <div style="float:left">        
            <% if (calendar.events_on(day).size < 0) %>
              <p class="linkToInfo <%= i.css_classes %> <%= 'starting' if day == i.start_date %> <%= 'ending' if day == i.due_date %>" id="linkToInfo_<%= i.id %>_<%= day %>" style="float:left; clear:left;"><%= link_to_issue(i,{:subject => false, :link_text => h(i.project).truncate(14)}) %></p>
           <% else %>
              <div class="linkToInfo box <%= i.css_classes %> <%= 'starting' if day == i.start_date %> <%= 'ending' if day == i.due_date %>" id="linkToInfo_<%= i.id %>_<%= day %>" style="background-color: #B<%= ('FF'.to_i(16)-i.project.to_s().length*2).to_s(16) %>;<%= ' width:10px; height:10px;' if (calendar.events_on(day).size > 8) %>"><%= link_to_issue(i,{:subject => false, :link_text => ' ', :title => false}) %></div>
           <% end %>
           <% if i.is_a? Issue %>
             <div class="infobox" id="info_<%= i.id %>"><%= render_issue_tooltip i %></div>
            <% end %>
          </div>
        <% end %>
      </div>
    </td>
<%= '</tr><tr>'.html_safe if day.cwday==calendar.last_wday and day!=calendar.enddt %>
    <% day = day + 1
    end %>
  </tr>
</tbody>
</table>

<%= javascript_tag "
  var $ = jQuery.noConflict();
	$(function() {
	  visiblity = 'visible';
		$('.linkToInfo').each(function(obj) {
		  $(this).hover(function() {
		    infobox = $(this).parent().find('.infobox');
		    infobox.css('visibility','visible');
		    infobox.hover( function () {
		      visiblity = 'visible';
		    }, function () {
		      $(this).css('visibility','hidden');
		    });
		  }, function () {  
		    visiblity = 'hidden';
		    id = $(this).attr('id');
		    setTimeout(\"$('#'+id).parent().find('.infobox').css('visibility',visiblity)\", 1);
		  });
		});
  });
  "%>