<%= error_messages_for 'member' %>
<% roles = Role.find_all_givable
   members = @project.member_principals.find(:all, :include => [:roles, :principal]).sort %>

<div class="splitcontentleft">
<% if members.any? %>
  <table class="list members" cellspacing="0">
    <thead>
      <tr>
        <th><%= l(:label_user) %> / <%= l(:label_group) %></th>
        <th><%= l(:label_role_plural) %></th>
        <th style="width:15%"></th>
        <%= call_hook(:view_projects_settings_members_table_header, :project => @project) %>
      </tr>
    </thead>
    <tbody>
    <% members.each do |member| %>
    <% next if member.new_record? %>
      <tr id="member-<%= member.id %>" class="<%= cycle 'odd', 'even' %> member">
        <td class="<%= member.principal.class.name.downcase %>" valign="top"><%= link_to_user member.principal %></td>
        <td class="roles" style="width: 200px;">
          <span id="member-<%= member.id %>-roles"><%=h member.roles.sort.collect(&:to_s).join(', ') %></span>
          <%= form_for(member, {:as => :membership, :remote => true, :url => membership_path(member), :method => :put, :html => { :id => "member-#{member.id}-roles-form", :class => 'hol' }}) do |f| %>
            <div style="float:left;">
            <% roles.each do |role| %>
              <%= check_box_tag 'membership[role_ids][]', role.id, member.roles.include?(role), :disabled => member.member_roles.detect {|mr| mr.role_id == role.id && !mr.inherited_from.nil?} %> <label><%=h role %></label>
              <div class="clearfix"></div>
            <% end %>
            </div>
            <%= hidden_field_tag 'membership[role_ids][]', '' %>
            <div style="float:left;">
              <%= submit_tag l(:button_change), :class => "small" %>
              <%= link_to_function l(:button_cancel), "$('#member-#{member.id}-roles').show(); $('#member-#{member.id}-roles-form').hide(); $('#member-#{member.id}').removeClass('edit'); return false;",:class => "button" %>
            </div>
          <% end %>
        </td>
        <td class="buttons" style="width:180px;">
          <%= link_to_function l(:button_edit), "$('#member-#{member.id}-roles').hide(); $('#member-#{member.id}-roles-form').show(); $('#member-#{member.id}').addClass('edit'); return false;", :class => 'button' %>
          <%= delete_link membership_path(member),
              :remote => true,
              :class => 'button',
              :no_text => true,
              :data => (!User.current.admin? && member.include?(User.current) ? {:confirm => l(:text_own_membership_delete_confirmation)} : {}) if member.deletable? %>
        </td>
        <%= call_hook(:view_projects_settings_members_table_row, { :project => @project, :member => member}) %>
      </tr>
  <% end; reset_cycle %>
    </tbody>
  </table>
<% else %>
<p class="nodata"><%= l(:label_no_data) %></p>
<% end %>
</div>

<% principals = Principal.active.not_member_of(@project).all(:limit => 100, :order => 'type, login, lastname ASC') %>

<div class="splitcontentright" id="profile" style="margin-top:20px;">
<% if roles.any? && principals.any? %>
  <%= form_for(@member, {:as => :membership, :remote => true, 
                     :url => project_memberships_path(@project), :method => :post,
                     :loading => '$(\'#member-add-submit\').disable();',
                     :complete => 'if($(\'#member-add-submit\')) $(\'#member-add-submit\').enable();'
                  } ) do |f| %>
    <fieldset><legend><%=l(:label_member_new)%></legend>

    <p><%= label_tag "principal_search", l(:label_principal_search) %><%= text_field_tag 'principal_search', nil %></p>
    <%= javascript_tag "observeSearchfield('principal_search', 'principals', '#{ escape_javascript autocomplete_project_memberships_path(@project) }')" %>

    <div id="principals" class="membership">
      <%#= principals_check_box_tags 'membership[user_ids][]', principals %>
    </div>

    <p class="membership"><%= l(:label_role_plural) %>:
    <% roles.each do |role| %>
      <label><%= check_box_tag 'membership[role_ids][]', role.id %> <%=h role %></label>
     <% end %></p>

    <p><%= submit_tag l(:button_add), :id => 'member-add-submit' %></p>
    </fieldset>
  <% end %>
<% end %>
</div>

<% content_for :header_tags do %>
  <%= stylesheet_link_tag 'profile' %>
<% end %>

